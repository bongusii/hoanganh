<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Kiểm tra kết nối Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .status-pending { background-color: #374151; color: #D1D5DB; }
        .status-success { background-color: #10B981; color: white; }
        .status-error { background-color: #EF4444; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-xl w-full bg-gray-800 p-8 rounded-lg shadow-2xl">
            <h1 class="text-2xl font-bold text-center mb-6">Trình chẩn đoán kết nối Firebase</h1>
            <div id="diagnostics-list">
                <div id="step1" class="status-item status-pending">Bước 1: Đang chờ tải tệp firebase-config.js...</div>
                <div id="step2" class="status-item status-pending">Bước 2: Đang chờ khởi tạo Firebase...</div>
                <div id="step3" class="status-item status-pending">Bước 3: Đang chờ đăng nhập ẩn danh...</div>
                <div id="step4" class="status-item status-pending">Bước 4: Đang chờ kết nối Firestore...</div>
            </div>
            <div id="final-result" class="mt-6 text-center text-lg font-semibold hidden"></div>
        </div>
    </div>

    <script type="module">
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const finalResult = document.getElementById('final-result');

        function updateStatus(element, success, message) {
            element.classList.remove('status-pending');
            element.classList.add(success ? 'status-success' : 'status-error');
            element.textContent = message;
        }

        async function runDiagnostics() {
            try {
                // Step 1: Check if config is loaded
                const configModule = await import('./firebase-config.js');
                if (configModule && configModule.auth && configModule.db) {
                    updateStatus(step1, true, '✅ Bước 1: Tải tệp firebase-config.js thành công.');
                } else {
                    throw new Error('Tệp firebase-config.js không chứa các export cần thiết.');
                }

                const { auth, db, projectsCollectionRef } = configModule;
                
                // Step 2: Firebase is already initialized in the config file
                updateStatus(step2, true, '✅ Bước 2: Khởi tạo Firebase thành công.');

                // Step 3: Sign in
                try {
                    const { signInAnonymously, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                    
                    await new Promise((resolve, reject) => {
                        const unsubscribe = onAuthStateChanged(auth, (user) => {
                            unsubscribe();
                            if (user) {
                                updateStatus(step3, true, `✅ Bước 3: Đăng nhập thành công với User ID: ${user.uid}`);
                                resolve(user);
                            } else {
                                // This part might not be hit if sign-in fails below, but good for safety
                                reject(new Error('Không nhận được thông tin user sau khi auth state thay đổi.'));
                            }
                        }, reject);

                        signInAnonymously(auth).catch(reject);
                    });

                } catch (error) {
                    updateStatus(step3, false, `❌ Bước 3: Đăng nhập ẩn danh thất bại. Lỗi: ${error.message}`);
                    throw error; // Stop the process
                }

                // Step 4: Test Firestore connection
                try {
                    const { getDocs } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                    await getDocs(projectsCollectionRef);
                    updateStatus(step4, true, '✅ Bước 4: Kết nối và đọc dữ liệu từ Firestore thành công.');
                } catch (error) {
                    updateStatus(step4, false, `❌ Bước 4: Kết nối Firestore thất bại. Lỗi: ${error.message}`);
                    throw error; // Stop the process
                }

                finalResult.textContent = '🎉 Chúc mừng! Mọi thứ đã được kết nối chính xác.';
                finalResult.classList.remove('hidden');
                finalResult.classList.add('text-green-400');

            } catch (error) {
                console.error("Lỗi chẩn đoán:", error);
                finalResult.textContent = '💔 Đã xảy ra lỗi. Vui lòng kiểm tra lại các bước trên và đảm bảo cấu hình chính xác.';
                finalResult.classList.remove('hidden');
                finalResult.classList.add('text-red-400');
            }
        }

        runDiagnostics();
    </script>
</body>
</html>
