<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Kiá»ƒm tra káº¿t ná»‘i Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .status-pending { background-color: #374151; color: #D1D5DB; }
        .status-success { background-color: #10B981; color: white; }
        .status-error { background-color: #EF4444; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-xl w-full bg-gray-800 p-8 rounded-lg shadow-2xl">
            <h1 class="text-2xl font-bold text-center mb-6">TrÃ¬nh cháº©n Ä‘oÃ¡n káº¿t ná»‘i Firebase</h1>
            <div id="diagnostics-list">
                <div id="step1" class="status-item status-pending">BÆ°á»›c 1: Äang chá» táº£i tá»‡p firebase-config.js...</div>
                <div id="step2" class="status-item status-pending">BÆ°á»›c 2: Äang chá» khá»Ÿi táº¡o Firebase...</div>
                <div id="step3" class="status-item status-pending">BÆ°á»›c 3: Äang chá» Ä‘Äƒng nháº­p áº©n danh...</div>
                <div id="step4" class="status-item status-pending">BÆ°á»›c 4: Äang chá» káº¿t ná»‘i Firestore...</div>
            </div>
            <div id="final-result" class="mt-6 text-center text-lg font-semibold hidden"></div>
        </div>
    </div>

    <script type="module">
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const finalResult = document.getElementById('final-result');

        function updateStatus(element, success, message) {
            element.classList.remove('status-pending');
            element.classList.add(success ? 'status-success' : 'status-error');
            element.textContent = message;
        }

        async function runDiagnostics() {
            try {
                // Step 1: Check if config is loaded
                const configModule = await import('./firebase-config.js');
                if (configModule && configModule.auth && configModule.db) {
                    updateStatus(step1, true, 'âœ… BÆ°á»›c 1: Táº£i tá»‡p firebase-config.js thÃ nh cÃ´ng.');
                } else {
                    throw new Error('Tá»‡p firebase-config.js khÃ´ng chá»©a cÃ¡c export cáº§n thiáº¿t.');
                }

                const { auth, db, projectsCollectionRef } = configModule;
                
                // Step 2: Firebase is already initialized in the config file
                updateStatus(step2, true, 'âœ… BÆ°á»›c 2: Khá»Ÿi táº¡o Firebase thÃ nh cÃ´ng.');

                // Step 3: Sign in
                try {
                    const { signInAnonymously, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                    
                    await new Promise((resolve, reject) => {
                        const unsubscribe = onAuthStateChanged(auth, (user) => {
                            unsubscribe();
                            if (user) {
                                updateStatus(step3, true, `âœ… BÆ°á»›c 3: ÄÄƒng nháº­p thÃ nh cÃ´ng vá»›i User ID: ${user.uid}`);
                                resolve(user);
                            } else {
                                // This part might not be hit if sign-in fails below, but good for safety
                                reject(new Error('KhÃ´ng nháº­n Ä‘Æ°á»£c thÃ´ng tin user sau khi auth state thay Ä‘á»•i.'));
                            }
                        }, reject);

                        signInAnonymously(auth).catch(reject);
                    });

                } catch (error) {
                    updateStatus(step3, false, `âŒ BÆ°á»›c 3: ÄÄƒng nháº­p áº©n danh tháº¥t báº¡i. Lá»—i: ${error.message}`);
                    throw error; // Stop the process
                }

                // Step 4: Test Firestore connection
                try {
                    const { getDocs } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                    await getDocs(projectsCollectionRef);
                    updateStatus(step4, true, 'âœ… BÆ°á»›c 4: Káº¿t ná»‘i vÃ  Ä‘á»c dá»¯ liá»‡u tá»« Firestore thÃ nh cÃ´ng.');
                } catch (error) {
                    updateStatus(step4, false, `âŒ BÆ°á»›c 4: Káº¿t ná»‘i Firestore tháº¥t báº¡i. Lá»—i: ${error.message}`);
                    throw error; // Stop the process
                }

                finalResult.textContent = 'ğŸ‰ ChÃºc má»«ng! Má»i thá»© Ä‘Ã£ Ä‘Æ°á»£c káº¿t ná»‘i chÃ­nh xÃ¡c.';
                finalResult.classList.remove('hidden');
                finalResult.classList.add('text-green-400');

            } catch (error) {
                console.error("Lá»—i cháº©n Ä‘oÃ¡n:", error);
                finalResult.textContent = 'ğŸ’” ÄÃ£ xáº£y ra lá»—i. Vui lÃ²ng kiá»ƒm tra láº¡i cÃ¡c bÆ°á»›c trÃªn vÃ  Ä‘áº£m báº£o cáº¥u hÃ¬nh chÃ­nh xÃ¡c.';
                finalResult.classList.remove('hidden');
                finalResult.classList.add('text-red-400');
            }
        }

        runDiagnostics();
    </script>
</body>
</html>
